<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Formulario Acompa√±antes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <div class="card">
            <div class="card-header">
                <h3>Debug - Secci√≥n de Acompa√±antes</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">C√≥digo de Invitaci√≥n</label>
                    <input type="text" class="form-control" id="codigo" placeholder="EV678JP">
                    <button class="btn btn-primary mt-2" onclick="validarCodigo()">Validar C√≥digo</button>
                </div>
                
                <div id="resultado" class="alert alert-info" style="display: none;">
                    <h5>Resultado de Validaci√≥n:</h5>
                    <p id="resultadoTexto"></p>
                </div>
                
                <!-- Secci√≥n de Acompa√±antes -->
                <div class="mb-4" id="acompanantesSection" style="display: none;">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-users me-2"></i>Acompa√±antes
                    </h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Puedes registrar hasta <span id="maxAcompanantes">0</span> acompa√±antes
                    </div>
                    
                    <div id="acompanantesList">
                        <!-- Los acompa√±antes se agregar√°n din√°micamente aqu√≠ -->
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addAcompananteBtn" style="display: none;">
                        <i class="fas fa-plus me-1"></i>Agregar Acompa√±ante
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let maxAcompanantes = 0;
        let acompanantes = [];

        function validarCodigo() {
            const codigo = document.getElementById('codigo').value.trim().toUpperCase();
            console.log('üîç Validando c√≥digo:', codigo);
            
            fetch(`${API_BASE}/invitaciones/validar-codigo/${codigo}`)
                .then(response => response.json())
                .then(data => {
                    console.log('üìã Respuesta del servidor:', data);
                    
                    if (data.success) {
                        maxAcompanantes = data.invitacion.numero_acompanantes || 0;
                        console.log('üë• N√∫mero de acompa√±antes:', maxAcompanantes);
                        
                        document.getElementById('resultadoTexto').innerHTML = `
                            <strong>Evento:</strong> ${data.invitacion.evento.nombre_evento}<br>
                            <strong>Acompa√±antes permitidos:</strong> ${maxAcompanantes}
                        `;
                        document.getElementById('resultado').style.display = 'block';
                        
                        // Configurar secci√≥n de acompa√±antes
                        document.getElementById('maxAcompanantes').textContent = maxAcompanantes;
                        if (maxAcompanantes > 0) {
                            console.log('‚úÖ Mostrando secci√≥n de acompa√±antes');
                            document.getElementById('acompanantesSection').style.display = 'block';
                            document.getElementById('addAcompananteBtn').onclick = agregarAcompanante;
                        } else {
                            console.log('‚ùå No hay acompa√±antes permitidos');
                        }
                    } else {
                        document.getElementById('resultadoTexto').textContent = data.message || 'Error';
                        document.getElementById('resultado').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    document.getElementById('resultadoTexto').textContent = 'Error al validar c√≥digo';
                    document.getElementById('resultado').style.display = 'block';
                });
        }

        function agregarAcompanante() {
            if (acompanantes.length >= maxAcompanantes) {
                alert('Has alcanzado el m√°ximo de acompa√±antes permitidos');
                return;
            }
            
            const acompananteId = Date.now();
            const acompanante = {
                id: acompananteId,
                nombre: '',
                cedula: '',
                correo: '',
                telefono: '',
                cargo: '',
                empresa: ''
            };
            
            acompanantes.push(acompanante);
            renderizarAcompanantes();
        }
        
        function eliminarAcompanante(id) {
            acompanantes = acompanantes.filter(acompanante => acompanante.id !== id);
            renderizarAcompanantes();
        }
        
        function actualizarAcompanante(id, campo, valor) {
            const acompanante = acompanantes.find(acompanante => acompanante.id === id);
            if (acompanante) {
                acompanante[campo] = valor;
            }
        }
        
        function renderizarAcompanantes() {
            const container = document.getElementById('acompanantesList');
            const addBtn = document.getElementById('addAcompananteBtn');
            
            container.innerHTML = '';
            
            acompanantes.forEach((acompanante, index) => {
                const acompananteDiv = document.createElement('div');
                acompananteDiv.className = 'card mb-3';
                acompananteDiv.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Acompa√±ante ${index + 1}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarAcompanante(${acompanante.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Nombre Completo *</label>
                                <input type="text" class="form-control" 
                                       value="${acompanante.nombre}"
                                       onchange="actualizarAcompanante(${acompanante.id}, 'nombre', this.value)"
                                       required>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">C√©dula</label>
                                <input type="text" class="form-control" 
                                       value="${acompanante.cedula}"
                                       onchange="actualizarAcompanante(${acompanante.id}, 'cedula', this.value)">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Correo</label>
                                <input type="email" class="form-control" 
                                       value="${acompanante.correo}"
                                       onchange="actualizarAcompanante(${acompanante.id}, 'correo', this.value)">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control" 
                                       value="${acompanante.telefono}"
                                       onchange="actualizarAcompanante(${acompanante.id}, 'telefono', this.value)">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(acompananteDiv);
            });
            
            // Mostrar/ocultar bot√≥n de agregar
            if (acompanantes.length < maxAcompanantes) {
                addBtn.style.display = 'inline-block';
            } else {
                addBtn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
